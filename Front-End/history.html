{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PGC - My History</title>
    <link rel="stylesheet" href="{% static 'css/history.css' %}">
</head>

<body>
    <div class="container">
        <header>
            <a href="{% url 'index' %}">&larr; Back to Home</a>
            <h1>My Grade History</h1>
        </header>

        <div class="table-wrapper">
            <table id="history-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Semester</th>
                        <th>Year</th>
                        <th>GPA (4.0)</th>
                        <th>Percent</th>
                        <th>Grade</th>
                        <th>Date Saved</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody id="history-body">
                    <tr>
                        <td colspan="8" style="padding: 20px; color: #666;">Loading records...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", async () => {
            const tbody = document.getElementById("history-body");
            const token = localStorage.getItem("access");

            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ token ‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ login
            if (!token) {
                console.warn("No token found, redirecting...");
                window.location.href = "/login/";
                return;
            }

            try {
                // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å API ‡πÇ‡∏î‡∏¢‡πÅ‡∏ô‡∏ö token
                const res = await fetch("/api/my-history/", {
                    method: "GET",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${token}`
                    }
                });

                // ‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡πà‡∏≤‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö ok ‡∏°‡∏±‡πâ‡∏¢
                if (!res.ok) {
                    console.error("Failed to fetch history:", res.status, await res.text());
                    tbody.innerHTML = `
                    <tr><td colspan="8" style="padding:20px; color:red;">
                        Error ${res.status}: Unauthorized or expired token.
                    </td></tr>`;
                    return;
                }

                const data = await res.json();
                console.log("History data:", data); // Debug ‡∏î‡∏π‡πÑ‡∏î‡πâ‡πÉ‡∏ô Console

                tbody.innerHTML = "";

                if (!data.length) {
                    tbody.innerHTML = `<tr><td colspan="8" style="padding: 20px; color:#777;">No records found.</td></tr>`;
                    return;
                }

                // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á
                data.forEach(item => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                    <td>${item.id}</td>
                    <td>${item.semester}</td>
                    <td>${item.year}</td>
                    <td>${item.gpa4?.toFixed(2) ?? "-"}</td>
                    <td>${item.total_gpa?.toFixed(2) ?? "-"}</td>
                    <td>${item.grade_letter}</td>
                    <td>${item.created_at ? new Date(item.created_at).toLocaleString() : "-"}</td>
                    <td><button class="view-btn">üîΩ View</button></td>
                `;
                    tbody.appendChild(row);

                    const detailRow = document.createElement("tr");
                    detailRow.classList.add("details-row");
                    detailRow.innerHTML = `
                    <td colspan="8">
                        <div class="details-box" style="display:none;">
                            <strong>Subjects in this GPA calculation:</strong>
                            <table>
                                <thead>
                                    <tr><th>Subject Name</th><th>Score (%)</th><th>Credit</th></tr>
                                </thead>
                                <tbody>
                                    ${(item.subjects || [])
                            .map(s =>
                                `<tr><td>${s.subject_name}</td><td>${s.score.toFixed(2)}</td><td>${s.credit}</td></tr>`
                            )
                            .join("")}
                                </tbody>
                            </table>
                        </div>
                    </td>
                `;
                    tbody.appendChild(detailRow);

                    const btn = row.querySelector(".view-btn");
                    const box = detailRow.querySelector(".details-box");
                    btn.addEventListener("click", () => {
                        const isHidden = box.style.display === "none";
                        box.style.display = isHidden ? "block" : "none";
                        btn.textContent = isHidden ? "üîº Hide" : "üîΩ View";
                    });
                });
            } catch (err) {
                console.error("Error loading history:", err);
                tbody.innerHTML = `<tr><td colspan="8" style="padding:20px; color:red;">Failed to load history.</td></tr>`;
            }
        });
    </script>

</body>

</html>