{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PGC - Home</title>
    <link rel="stylesheet" href="{% static 'css/style.css' %}" />
    <link rel="stylesheet" href="{% static 'css/index.css' %}" />
  </head>

  <body>
    <div class="container">
      <header>
        <h1>Personal Grade Calculator</h1>
        <p>Welcome to the best Grade calculator!!</p>
      </header>

      <main class="main-content">
        <div class="home-menu">
          <a href="/add-record/" class="menu-button">Add New Record</a>

          <a
            href="{% url 'history_page' %}"
            class="menu-button menu-button-secondary"
          >
            View My History
          </a>

          <a
            href="{% url 'whatif_page' %}"
            class="menu-button menu-button-warning"
          >
            What-IF?
          </a>

          <a
            href="{% url 'graph_page' %}"
            class="menu-button menu-button-secondary"
          >
            GPA Charts
          </a>

          <a href="/admin/" class="menu-button menu-button-secondary">
            Admin Panel
          </a>

          <button id="logout-btn" class="menu-button menu-button-important">
            Log Out
          </button>
        </div>
      </main>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", async () => {
        const token = localStorage.getItem("access");
        const refresh = localStorage.getItem("refresh");

        if (!token) {
          window.location.href = "/login/";
          return;
        }

        try {
          const res = await fetch("/api/gpa-tracking/", {
            headers: { Authorization: "Bearer " + token },
          });

          // ถ้า token หมดอายุ ให้ลอง refresh
          if (res.status === 401 && refresh) {
            console.log("Access expired. Trying refresh...");
            const refreshRes = await fetch("/api/auth/refresh/", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ refresh }),
            });

            const data = await refreshRes.json();
            if (refreshRes.ok && data.access) {
              localStorage.setItem("access", data.access);
              console.log("Token refreshed successfully.");
            } else {
              console.warn("Refresh failed, redirecting...");
              localStorage.removeItem("access");
              localStorage.removeItem("refresh");
              window.location.href = "/login/";
            }
          } else if (res.status === 401) {
            console.warn("Token invalid, redirecting...");
            localStorage.removeItem("access");
            localStorage.removeItem("refresh");
            window.location.href = "/login/";
          }
        } catch (err) {
          console.error("Error verifying token:", err);
          window.location.href = "/login/";
        }

        const logoutBtn = document.getElementById("logout-btn");
        logoutBtn.addEventListener("click", () => {
          localStorage.removeItem("access");
          localStorage.removeItem("refresh");
          window.location.href = "/login/";
        });
      });
    </script>
  </body>
</html>
